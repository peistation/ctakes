Contents
- Disclaimer
- Introduction
- Overview of spoking status pipeline
- Prerequisite steps
- Getting Started (test sample run)
- Verify Results  (test sample run)
- How to use the trained libSVM model
- Description of shipped resources
- Debugging issues
- Release Notes
	
##########
Disclaimer
##########

This should be considered a beta release of this annotator. 

############  
Introduction
############

This is version 1.2 of the cTAKES smoking status annotator.  The pipeline has been tested on flat text files and CDA documents.  The sample provided uses a bar (|) delimited file with multiple records (and patients) per file.  The dictionary
lookup annotator is limited to smoking status dictionaries provided in the '/smokingresources/data/*.dictionary' files.  Specific details can be found in the 'smokingStatus_AMIA2009.pdf' and the 'smokingStatus_Overview.html' files.

#####################################
Overview of spoking status pipeline
#####################################

The smoking status pipeline processes patient records into five pre-determined categories - past smoker (P), current smoker (C), smoker (S), non-smoker (N), and unknown (U). The definition of smoking status was adapted from I2B2 
Natural Language Processing Challenges for Clinical Records [1]: 

"	PAST SMOKER (P): A patient whose record asserts either that they are a past smoker or that they were a smoker a year or more ago but who have not smoked for at least one year.
"	CURRENT SMOKER (C): A patient whose record asserts that they are a current smoker (or that they smoked without indicating that they stopped more than a year ago) or that they were a smoker within the past year.
"	SMOKER (S): A patient who is either a CURRENT or a PAST smoker but, whose medical record does not provide enough information to classify the patient as either a CURRENT or a PAST smoker.
"	NON-SMOKER (N): A patient whose record indicates that they have never smoked.
"	UNKNOWN (U): The patient's record does not mention anything about smoking.


The algorithm for classifying at the document level is as follows:

If (exist any sentence classified as C)
Label that doc as C
   Else If (exist a sentence classified as P)
Label that doc as P
   Else If (exist a sentence classified as S)
Label that doc as S
   Else If (exist a sentence classified as N)
Label that doc as N
        Else (i.e., all sentences are classified as U)
Label that doc as U

The algorithm for classifying at the patient level is as follows:

If (exist a doc classified as C or P)
	If (exist C but no P)
		Label that patient as C
	Else If (exist P but no C)
		Label that patient as P
	Else (i.e., exist both C and P)
		If (freq of C >= freq of P)
			Label that patient as C
		Else Label that patient as P
Else If (exist a doc classified as S)
	Label that patient as S
Else If (exist a doc classified as N)
	Label that patient as N
Else (i.e., all docs are classified as U)
	Label that patient as U


See the 'smokingStatus_AMIA2009.pdf' for a more detailed discussion.

##################
Prerequisite steps
##################

	- Install all the cTAKES components, dependencies (e.g. JVM, UIMA, and Eclipse(optional)).
    
	- Make sure the clinical documents pipeline of cTAKES and the Apache UIMA are setup correctly by running the CAS Visual Debugger (CVD) as 
	described in the 'Clinical Text	Analysis and Knowledge Extraction System User Guide' 1.2. Install from PEAR packages.
  
	- Install the 'smoking status.pear' after completing the installation of the core and related pears, as per above.
	NOTE: Do not utilize the 'Run your AE in the CAS Visual Debugger'(CVD) step as in other cTAKES module installations.  Instead use the 
	'Getting Started' section below for verification purposes.  The AE infrastructure of the 'SimulatedProdSmokingAE' indirectly utilizes other
	AEs not directly in the flow, therefore, the results of running the CVD from the pear installer are very unpredictable.

#################################
Getting Started (test sample run)
#################################

Reference the "$cTAKES_HOME/docs/smokingdoc/smokingStatus_AMIA2009.pdf.pdf' for additional documentation for this pipeline.

This pipeline utilizes three main flows inherent in the UIMA infrastructure to parse, analyze and summarize the radiology notes PAD classification.
The Component Processing Engine (CPE) responsible for putting the different flows together to create, modify, and deploy the system.  

Step 1: From the $cTAKES_HOME, click runcTAKES.sh (Linux/Unix) or runcTAKES.bat  which will open a CPE.
 
Step 2: From the pull down menu open the $cTAKES_HOME/cTAKESdesc/smokingdesc/collection_processing_engine/Sample_SmokingStatus_output_flatfile.xml

This will load the sample Collection Processing Engine (CPE) 'Sample_SmokingStatus_output_flatfile.xml'.  
A sample CPE has been provided along with de-identified patient information to provide a means to test the pipeline after you have set up the environment. FYI.  '{inst-root-dir}/data/test' contains 5 sample notes representing one patients
multiple visits to a health service provider.

Step 3: The input of the sample CPE is from $cTAKES_HOME/testdata/smokingtest/testinput and the output is available at $cTAKES_HOME/testdata/smokingtest/testoutput.

#################################
Verify Results  (test sample run)
#################################
The output file will contain a 5 rows of data corresponding to each document contained in the input as follows:

doc1_07543210_sample_current.txt|CURRENT_SMOKER
doc1_07543210_sample_past_smoker.txt|PAST_SMOKER
doc1_07543210_sample_unknown.txt|UNKNOWN
doc2_07543210_sample_current.txt|CURRENT_SMOKER
doc2_07543210_sample_past_smoker.txt|PAST_SMOKER

Each field is delimited using the vertical bar (|).  The first column shows the patient number and known classification.  The second column contains the discovered smoking classification.

The 'record_resolution.txt_patientLevel.txt' should contain the following:

07543210|CURRENT_SMOKER

###################################
How to use the trained libSVM model
###################################

To use libSVM: In ClassifiableEntriesAnnotator.xml, set a parameter of UimaDescriptorStep2 to "ProductionPostSentenceAggregate_step2_libsvm.xml"
Trained model of libSVM is in: $cTAKES_HOME/resources/smokingresources/data/PCS/pcs_libsvm-2.91.model

cf) libSVM Command used to create this trained model: java svm_train -s 0 -t 1 -g 1 -r 1 -d 1 training_data model_name

The algorithm used in this smoking status classification is described in: 
S. Sohn and GK. Savova, 'Mayo Clinic Smoking Status Classification System: Extensions and Improvements' AMIA 2009 Annual Symposium, San Francisco, pp 619-623, Nov. 2009. 
(Please note that we replaced the Weka SVM classifier described in this paper with libSVM in the released pipeline.)

################################
Description of shipped resources
################################
The directory $cTAKES_HOME/resources/smokingresources/ contains the following resources:
data/context/negationContradictionWords.txt: If those words appear in the sentence along with a negation marker, the negation detection component is not triggered.
data/KU/keywords.txt: a set of smoking-related keywords. If those keywords appear in the sentence, "known" is assigned. If not "unknown" is assigned. 
data/KU/unknown_words.txt: If those words appear along with smoking-related keywords, "known" is not assigned.
data/smoker.dictionary and nonsmoker.dictionary: dictionaries to be used for name entities of SmokerNamedEntityAnnotation and NonSmokerNamedEntityAnnotation. Each includes smoker or nonsmoker keywords respectively.
data/PCS/keywords_PCS: keywords used to build feature vectors of the PCS classifier
data/PCS/pcs_libsvm-2.91.model: the trained model using libSVM for the PCS classification


 #############
 Release Notes
 #############
 
Version 1.2.2 is the attempt to make cTAKES as a comprehensive package carried out Mayo NLP program led by Hongfang Liu, Mayo Clinic.   
  
